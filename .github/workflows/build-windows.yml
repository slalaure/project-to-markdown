name: Build Installers

on:
  workflow_dispatch: # Allows manual triggering

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flet
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build Windows portable app
        run: |
          # This creates the portable bundle in 'build/Project To Markdown'
          flet pack main.py --name "Project To Markdown" --product-version 1.0.0 --add-data "assets:assets" --add-data "config.json:."

      - name: Create portable ZIP archive
        run: |
          # Rename the correct output folder 'build/Project To Markdown'
          Rename-Item -Path "build\Project To Markdown" -NewName "Project-To-Markdown-Portable"
          # Create a zip file from this renamed folder
          Compress-Archive -Path "build\Project-To-Markdown-Portable" -DestinationPath "dist\Project-To-Markdown-Portable.zip"
        shell: pwsh

      - name: Upload artifact (Windows Portable)
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable-zip
          path: dist\Project-To-Markdown-Portable.zip

  build-macos-arm64:
    runs-on: macos-14 # This runner is Apple Silicon (arm64)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flet
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Build macOS portable app
        run: |
          # This creates the app bundle at 'dist/Project To Markdown.app'
          flet pack main.py --name "Project To Markdown" --product-version 1.0.0 --add-data "assets:assets" --add-data "config.json:."

      - name: Sign macOS app (ad-hoc)
        run: |
          # This ad-hoc signature can help with Gatekeeper issues
          codesign --force --deep --sign - "dist/Project To Markdown.app"
        shell: bash

      - name: Create portable ZIP archive (macOS)
        run: |
          # We zip the .app bundle for portable distribution
          cd dist
          zip -r "Project-To-Markdown-macOS-arm64.zip" "Project To Markdown.app"
        shell: bash

      - name: Upload artifact (macOS Portable)
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-portable-zip
          path: dist/Project-To-Markdown-macOS-arm64.zip